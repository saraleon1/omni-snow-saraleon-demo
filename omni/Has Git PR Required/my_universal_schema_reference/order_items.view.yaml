# Reference this view as my_universal_schema_reference__order_items
label: Order Item
schema_label: ""

schema: my_universal_schema_reference
table_name: ORDER_ITEMS

dimensions:
  order_item_id:
    sql: '"ORDER_ITEM_ID"'
    format: ID
    primary_key: true

  order_id:
    sql: '"ORDER_ID"'
    format: ID

  product_id:
    sql: '"PRODUCT_ID"'
    format: ID

  ordered_at:
    sql: '"ORDERED_AT"'

  product_name:
    sql: '"PRODUCT_NAME"'

  product_price:
    sql: '"PRODUCT_PRICE"'

  is_food_item:
    sql: '"IS_FOOD_ITEM"'

  is_drink_item:
    sql: '"IS_DRINK_ITEM"'

  supply_cost:
    sql: '"SUPPLY_COST"'

  _entity_order_item:
    # Entity is defined in the 'order_item' dbt semantic model (models/marts/order_items.yml)
    sql: ${my_universal_schema_reference__order_items.order_item_id}
    hidden: true

  _entity_order_id:
    # Entity is defined in the 'order_item' dbt semantic model (models/marts/order_items.yml)
    sql: ${my_universal_schema_reference__order_items.order_id}
    hidden: true

  _entity_product:
    # Entity is defined in the 'order_item' dbt semantic model (models/marts/order_items.yml)
    sql: ${my_universal_schema_reference__order_items.product_id}
    hidden: true

measures:
  count:
    aggregate_type: count

  revenue:
    # Measure is defined by the 'revenue' dbt metric (models/marts/order_items.yml)
    sql: ${my_universal_schema_reference__order_items.product_price}
    label: Revenue
    description: Sum of the product revenue for each order item. Excludes tax.
    aggregate_type: sum

  food_revenue:
    # Measure is defined by the 'food_revenue' dbt metric (models/marts/order_items.yml)
    sql: CASE WHEN ${my_universal_schema_reference__order_items.is_food_item} THEN
      ${my_universal_schema_reference__order_items.product_price} ELSE 0 END
    label: Food Revenue
    description: The revenue from food in each order
    aggregate_type: sum

  drink_revenue:
    # Measure is defined by the 'drink_revenue' dbt metric (models/marts/order_items.yml)
    sql: CASE WHEN ${my_universal_schema_reference__order_items.is_drink_item} THEN
      ${my_universal_schema_reference__order_items.product_price} ELSE 0 END
    label: Drink Revenue
    description: The revenue from drinks in each order
    aggregate_type: sum

  median_revenue:
    # Measure is defined by the 'median_revenue' dbt metric (models/marts/order_items.yml)
    sql: ${my_universal_schema_reference__order_items.product_price}
    label: Median Revenue
    description: The median revenue for each order item. Excludes tax.
    aggregate_type: median

  food_revenue_pct:
    # Measure is defined by the 'food_revenue_pct' dbt metric (models/marts/order_items.yml)
    sql: CAST(${my_universal_schema_reference__order_items.food_revenue} AS DOUBLE)
      / CAST(${my_universal_schema_reference__order_items.revenue} AS DOUBLE)
    label: Food Revenue %
    description: The % of order revenue from food.

  drink_revenue_pct:
    # Measure is defined by the 'drink_revenue_pct' dbt metric (models/marts/order_items.yml)
    sql: CAST(${my_universal_schema_reference__order_items.drink_revenue} AS DOUBLE)
      / CAST(${my_universal_schema_reference__order_items.revenue} AS DOUBLE)
    label: Drink Revenue %
    description: The % of order revenue from drinks.

#The info below was pulled from your dbt repository and is read-only.
dbt:
  name: order_items
  target_schema: dbt_sleon_prod
  config:
    materialized: table
  code: |-
    with

    order_items as (

        select * from {{ ref('stg_order_items') }}

    ),


    orders as (

        select * from {{ ref('stg_orders') }}

    ),

    products as (

        select * from {{ ref('stg_products') }}

    ),

    supplies as (

        select * from {{ ref('stg_supplies') }}

    ),

    order_supplies_summary as (

        select
            product_id,

            sum(supply_cost) as supply_cost

        from supplies

        group by 1

    ),

    joined as (

        select
            order_items.*,

            orders.ordered_at,

            products.product_name,
            products.product_price,
            products.is_food_item,
            products.is_drink_item,

            order_supplies_summary.supply_cost

        from order_items

        left join orders on order_items.order_id = orders.order_id

        left join products on order_items.product_id = products.product_id

        left join order_supplies_summary
            on order_items.product_id = order_supplies_summary.product_id

    )

    select * from joined
  referenced_by: [ orders ]
